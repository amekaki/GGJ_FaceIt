# 项目结构说明

本文档说明本项目的目录划分、脚本与场景职责、数据流与关卡流程，便于协作方理解代码结构并参与开发。

---

## 一、目录总览

```
demo/
├── assets/                     # 资源
│   ├── level_config.json       # 关卡 1 节奏/波次配置（JSON）
│   ├── music/                  # 音效（如 tap.wav）
│   ├── test/player/            # 角色动画图集
│   ├── 说明.MD / 修改说明.md   # 需求与修改说明
│   └── ...
├── docs/                       # 设计文档
│   ├── Godot技术方案.md
│   ├── Godot技术方案-修订版.md
│   └── 项目结构说明.md         # 本文档
├── scenes/                     # 场景
│   ├── player.tscn             # 主角（可被关卡引用）
│   ├── enemy.tscn              # 敌人
│   ├── flying_text.tscn        # 飞行文字
│   ├── hud.tscn                # 关卡内 HUD（血条、退出按钮）
│   ├── levels/                 # 关卡场景（与 level 1/2 一一对应）
│   │   ├── level_1.tscn        # 第一关：节奏战
│   │   └── level_2.tscn        # 第二关：暂为通过本关按钮
│   └── ui/                     # 界面场景
│       ├── start_screen.tscn   # START 界面
│       ├── popup_level.tscn    # 关卡内弹窗（重新开始/下一关/通关）
│       └── end_screen.tscn    # 游戏结束界面
├── scripts/
│   ├── autoload/               # 自动加载单例（全局可用）
│   │   ├── game_config.gd      # 游戏配置（血量、速度、关卡 JSON 路径等）
│   │   └── save_manager.gd     # 存档（当前关卡索引）
│   ├── game/                   # 关卡逻辑与节奏
│   │   ├── level_1.gd          # 关卡 1：节奏战、波次、弹窗流程
│   │   ├── level_2.gd          # 关卡 2：通过本关、进入结束界面
│   │   └── beat_pattern.gd     # 节奏配置资源类（可选扩展）
│   ├── entities/               # 游戏实体脚本
│   │   ├── player.gd           # 主角：弹反、血条、状态动画
│   │   ├── enemy.gd            # 敌人：血量、受击、状态动画
│   │   └── flying_text.gd      # 飞行文字：攻击/弹回、伤害
│   └── ui/                     # 界面逻辑
│       ├── start_screen.gd     # START：开始/加载/退出游戏
│       ├── popup_level.gd      # 通用弹窗（标题+按钮）
│       ├── end_screen.gd       # 结束界面：恭喜通关
│       └── hud.gd              # HUD：血条、退出游戏按钮
├── project.godot               # 项目配置（主场景、Autoload）
└── icon.svg
```

---

## 二、脚本与场景对应关系

| 场景 | 脚本 | 说明 |
|------|------|------|
| `scenes/levels/level_1.tscn` | `scripts/game/level_1.gd` | 第一关：节奏驱动、生成飞行文字、胜负与弹窗 |
| `scenes/levels/level_2.tscn` | `scripts/game/level_2.gd` | 第二关：通过本关 → 弹窗 → 结束界面 |
| `scenes/player.tscn` | `scripts/entities/player.gd` | 主角：弹反区、HP、IDLE/ATTACK/DAMAGE/HAPPY/DEAD |
| `scenes/enemy.tscn` | `scripts/entities/enemy.gd` | 敌人：血量、受击、同上状态动画 |
| `scenes/flying_text.tscn` | `scripts/entities/flying_text.gd` | 飞行文字：攻击/弹回、伤害、波次索引 |
| `scenes/hud.tscn` | `scripts/ui/hud.gd` | 血条、退出游戏（右下角） |
| `scenes/ui/start_screen.tscn` | `scripts/ui/start_screen.gd` | 开始游戏 / 加载游戏 / 退出游戏 |
| `scenes/ui/popup_level.tscn` | `scripts/ui/popup_level.gd` | 弹窗：可配置标题与按钮，发出 `pressed` 信号 |
| `scenes/ui/end_screen.tscn` | `scripts/ui/end_screen.gd` | 恭喜通关、返回主界面 |

---

## 三、Autoload（全局单例）

在 `project.godot` 的 `[autoload]` 中注册，任意脚本可通过 `get_node("/root/GameConfig")` / `get_node("/root/SaveManager")` 或（若引擎识别）直接 `GameConfig` / `SaveManager` 使用。

| 名称 | 脚本路径 | 职责 |
|------|----------|------|
| **GameConfig** | `scripts/autoload/game_config.gd` | 常量：血量、速度、漏弹上限、关卡 JSON 路径、文字表等；静态方法：随机攻击词、反击词 |
| **SaveManager** | `scripts/autoload/save_manager.gd` | `save_level(level: int)` 写入当前关卡；`get_saved_level() -> int` 读取，供「加载游戏」使用 |

---

## 四、关卡流程与数据流

1. **启动**  
   主场景为 `scenes/ui/start_screen.tscn`。  
   - **开始游戏**：存档 1，切到 `scenes/levels/level_1.tscn`。  
   - **加载游戏**：读 `SaveManager.get_saved_level()`，为 1 进 level_1，否则进 level_2。  
   - **退出游戏**：`get_tree().quit()`。

2. **关卡 1（level_1.tscn + level_1.gd）**  
   - 读取 `assets/level_config.json`，按节拍生成飞行文字；每拍播放 tap 音效。  
   - 玩家血条归零 → 弹窗「失败」+「重新开始本关」→ 重载当前场景。  
   - 敌人被击败 → 弹窗「胜利」+「进入下一关」→ 存档 2，切到 `level_2.tscn`。  
   - HUD 右下角「退出游戏」常驻。

3. **关卡 2（level_2.tscn + level_2.gd）**  
   - 进入时存档 2。  
   - 点击「通过本关」→ 弹窗「游戏通关」+「进入游戏结束界面」→ 切到 `end_screen.tscn`。  
   - 右下角「退出游戏」同上。

4. **结束界面（end_screen.tscn）**  
   - 显示「恭喜通关」。  
   - 「返回主界面」→ 切回 `start_screen.tscn`。

---

## 五、模块职责与协作边界

| 模块 | 目录 | 职责 | 协作说明 |
|------|------|------|----------|
| **autoload** | `scripts/autoload/` | 全局配置与存档，无场景依赖 | 新增常量或存档字段时改这里；避免放关卡专属逻辑 |
| **game** | `scripts/game/` | 关卡入口、节奏、胜负与关卡间跳转 | 新增关卡可新增 `level_N.gd` + `level_N.tscn`，在 start_screen 与上一关的「下一关」中跳转 |
| **entities** | `scripts/entities/` | 玩家、敌人、飞行文字的属性和行为 | 改角色数值、弹反判定、动画触发等在此；尽量不依赖具体关卡场景结构 |
| **ui** | `scripts/ui/` | 主菜单、弹窗、HUD、结束界面 | 改按钮文案、弹窗样式、血条布局等在此 |

---

## 六、场景引用约定

- **关卡场景**（如 level_1）通过 `preload` 或路径引用：  
  `res://scenes/flying_text.tscn`、`res://scenes/ui/popup_level.tscn` 等。  
- **关卡 1** 使用 `res://assets/level_config.json`（路径来自 GameConfig）。  
- **场景内节点路径**：level_1 中固定为 `$GamePlay`、`$GamePlay/Player`、`$HUD`、`$BeatTimer`、`$TapSound` 等，脚本中写死路径；新增节点若被脚本引用需同步改脚本。

---

## 七、扩展新关卡时建议

1. 在 `scenes/levels/` 下新建 `level_N.tscn`，在 `scripts/game/` 下新建 `level_N.gd` 并挂到场景根节点。  
2. 在 `SaveManager` 中沿用现有「关卡索引」即可；若需多存档槽，再扩展 `save_manager.gd`。  
3. 上一关（如 level_1）胜利时 `change_scene_to_file("res://scenes/levels/level_N.tscn")` 并 `_save.save_level(N)`。  
4. 在 `start_screen.gd` 的「加载游戏」中根据 `get_saved_level()` 分支到对应 `level_N.tscn`。

---

## 八、文档与需求

- 玩法与规则：见 `assets/说明.MD`、`assets/修改说明.md` 等。  
- 技术方案与修订：见 `docs/Godot技术方案.md`、`docs/Godot技术方案-修订版.md`。

以上为当前项目结构说明，便于协作方快速定位与参与开发。
