# Godot 技术方案（文字弹反节奏战）

> 基于 `assets/说明.MD` 的设定，仅做架构与方案设计，不涉及具体实现。

---

## 一、整体架构

### 1.1 场景与节点规划

| 场景/节点 | 职责 |
|-----------|------|
| **Main**（主场景） | 游戏入口：挂载主流程、节奏驱动、胜负判定；包含 UI 层、游戏层、背景层。 |
| **GamePlay**（子场景或节点） | 游戏层容器：主角、敌人、所有「飞行文字」的父节点；负责生成/回收文字、碰撞检测。 |
| **Player**（主角） | 精灵图（player.jpg）、位置在右侧；挂载输入检测、弹反技能触发与冷却、受击（若需要）。 |
| **Enemy**（敌人） | 精灵图（target.jpg）、位置在左侧；挂载血量、被弹回文字命中时的受伤逻辑、死亡处理。 |
| **FlyingText**（飞行文字） | 单颗「恶意文字」实体：从左侧飞向右侧；可被弹反后变为「反击文字」飞回左侧。 |
| **HUD / UI** | 敌人血条、可选节奏指示、结算界面（胜利/失败）。 |

### 1.2 数据与状态流

- **节奏系统** → 按节拍（含空拍）在 Enemy 侧生成 FlyingText，并决定生成间隔（越往后越快）。
- **FlyingText** → 飞行到 Player 侧「可弹反区域」时，等待玩家输入；若在规定时机内输入则变为「被弹回」状态并换字，飞向 Enemy。
- **Enemy** → 被「弹回的文字」命中时扣血，血量为 0 时触发死亡，主场景进入胜利流程。

---

## 二、核心系统设计

### 2.1 节奏与攻击生成系统

- **节奏数据**：用资源（如 `Resource`）或配置文件定义「节拍序列」：每个节拍可以是「生成文字」或「空拍」；可配置 BPM 或每拍时长，以及「随进度加快」的规则（例如每 N 拍缩短间隔）。
- **驱动方式**：在主场景或独立节点用 `Timer` 或基于 `AudioStreamPlayer` 的节拍同步，在「该生成」的节拍上调用 Enemy 或生成器的接口，生成一枚 FlyingText。
- **生成位置**：在 Enemy 附近（左侧）实例化 FlyingText，初始方向朝右（飞向主角）。

### 2.2 飞行文字（FlyingText）系统

- **状态**：  
  - `ATTACKING`：从左侧飞向右侧（恶意文字）；  
  - `RETURNING`：被弹反后飞向左侧（反击文字），命中敌人造成伤害。
- **属性**：  
  - 当前显示文字（可随机或按表从「恶意词」换为「反击词」）；  
  - 飞行速度、方向；  
  - 归属（攻击阶段属于敌人，弹反后属于「对敌人的反击」）。
- **碰撞与触发**：  
  - 与 Player 的「弹反区域」重叠且在可弹反时间窗内 → 触发弹反逻辑，切到 RETURNING，换字并反向飞行。  
  - 与 Enemy 碰撞且处于 RETURNING → 对 Enemy 造成伤害，然后销毁自身（或回收到对象池）。
- **表现**：用 `Label` 或 `RichTextLabel` 显示文字，可加简单 Tween 做缩放/透明度增强打击感。

### 2.3 弹反技能系统

- **输入**：在 Player 节点中检测指定按键（如空格/鼠标/自定义动作），仅在「弹反窗口」内有效。
- **弹反窗口**：由 FlyingText 进入「可弹反区域」时开始，可用固定时长或按文字到达中心点的前后几帧；可通过信号或组查询当前在区域内的 FlyingText。
- **逻辑**：  
  - 在窗口内按下 → 取「最近」或「最先进入」的一颗 FlyingText，将其设为 RETURNING、换字、反向；可选：播放音效、镜头抖动、主角动画。  
  - 未在窗口内按或按错 → 可视为「未弹反」，文字继续飞行并视为对主角的失败（可扣血或记失误，按需求扩展）。

### 2.4 敌人血量与受伤

- **血量**：在 Enemy 节点用变量存储当前 HP，最大 HP 可配置（导出变量或资源）。
- **受伤**：当 FlyingText（RETURNING）与 Enemy 的碰撞体重叠时，Enemy 接收伤害值（可来自 FlyingText 或全局配置），扣血并刷新血条 UI；若 HP ≤ 0，播放死亡逻辑并通知 Main 胜利。
- **血条**：用 `TextureProgressBar` 或 `ProgressBar` 绑定 Enemy 的当前/最大 HP，可在 HUD 或挂在 Enemy 上方。

### 2.5 胜负与流程

- **胜利**：Enemy HP 归零 → Main 切到胜利界面或场景，可带简单统计（弹反次数、用时等）。
- **失败**：若设定「未弹反到的文字会伤到主角」，则主角 HP 归零时触发失败；否则可做成「漏弹次数达到 N 即失败」或计时失败，由 Main 统一处理。

---

## 三、资源与配置建议

| 类型 | 说明 |
|------|------|
| **精灵** | `assets/player.jpg` → Player；`assets/target.jpg` → Enemy；按需做 Sprite2D 或 AnimatedSprite2D。 |
| **场景** | `Main.tscn`、`Player.tscn`、`Enemy.tscn`、`FlyingText.tscn`、`HUD.tscn` 等，便于复用与测试。 |
| **节奏配置** | 建议单独资源（如 `beat_pattern.tres`）或 JSON：节拍序列、BPM、加速曲线、空拍位置。 |
| **文字表** | 恶意词列表、反击词列表（或一一对应），用于 FlyingText 的显示与弹反后换字。 |

---

## 四、技术要点小结

1. **节奏**：Timer 或音频节拍 + 配置化序列，支持空拍与逐渐加速。  
2. **文字生命周期**：生成 → 飞向玩家 → 可弹反窗口 → 弹反后换字飞回 → 命中敌人后销毁。  
3. **碰撞**：Area2D 用于「弹反区域」与「文字-敌人」检测，避免用 KinematicBody2D 做纯重叠检测。  
4. **扩展性**：FlyingText 用场景+脚本，便于后续加多种文字类型、不同速度与伤害。  
5. **先不实现**：本方案仅作技术方案，具体脚本与场景实现按此方案再分步落地。

如需下一步，可以从「Main + 节奏驱动 + 单颗 FlyingText 生成与飞行」开始实现，再接入弹反与敌人血量。
